<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.portal.community.dao.PromotionDao">

<select id="search" parameterType="map" resultType="ParamMap">
    	WITH WW AS
		(
			SELECT      
			       	A.ID
			,       A.TITLE
			,       A.USER_ID
			,       FN_USER_NAME(A.USER_ID) USER_NAME
			,       FN_TO_CHAR(CREATE_DATE, 'YYYY-MM-DD') CREATE_DATE
			,		A.HIT
			,		A.WRITE_YMD
			,		A.BBS_CATEGORY
			,       A.ATTACH_FILE_URL1
			,       A.ATTACH_FILE_URL2
			,       A.ATTACH_FILE_URL3
			,       A.ATTACH_FILE_URL4
			,       A.ATTACH_FILE_URL5
			<![CDATA[
            ,       CASE WHEN FN_TO_CHAR(NOW(), 'YYYYMMDD') <= FN_TO_CHAR(A.DATE_TO, 'YYYYMMDD') THEN A.BANNER_REGI_YN
                         ELSE 'N'
                    END BANNER_REGI_YN
            ]]>
			,		A.BBS_SHOW_YN
			,		FN_CODE_NAME('PROMOTION_CATEGORY',A.BBS_CATEGORY) BBS_CATEGORY_NAME
			,       ROW_NUMBER() OVER (ORDER BY ID) RID
			FROM    BBS     A 
			WHERE   BBS_TYPE    = 'C'
			AND     WRITE_YMD   > '19900101'
		)   
        SELECT                
                *
        FROM    WW          
        WHERE   1    = 1
        <if test="searchTxt != null">        	
	        <choose>
		        <when test='searchCond == "A"'>
		        AND     TITLE     LIKE '%' + #{searchTxt} + '%'
		        </when>
		        <when test='searchCond == "B"'>
		        AND     CONTENTS  LIKE '%' + #{searchTxt} + '%'
		        </when>
		        <when test='searchCond == "C"'>
		        AND     (
		                      TITLE     LIKE '%' + #{searchTxt} + '%'
		                  OR  CONTENTS  LIKE '%' + #{searchTxt} + '%'
		                )
		        </when>
		        <when test='searchCond == "D"'>
		        AND     WRITE_YMD = #{searchTxt}
		        </when>
		        <when test='searchCond == "E"'>
		        AND     FN_USER_NAME(USER_ID) LIKE '%' +  #{searchTxt} + '%'
		        </when>
	        </choose>
       </if>
       <if test="searchGubun != null">
      		AND BBS_CATEGORY =	#{searchGubun}
       </if>       
       <if test='loginUserRole != "R999" and loginUserRole != "RDEV"'>
       		AND BBS_SHOW_YN	 = 'Y'
       </if>
        <if test='dateUse != 0'>
        AND     WRITE_YMD          BETWEEN REPLACE(#{startDate},'-','') AND REPLACE(#{endDate},'-','')
        </if>
        ORDER BY RID DESC
        OFFSET ${startPage} ROWS FETCH NEXT ${paging} ROWS ONLY
    </select>
    
     <select id="searchBannerCount" parameterType="map" resultType="int">
    	SELECT
    			COUNT(*) CNT
    	FROM    BBS     A 
        WHERE   BBS_TYPE    = 'C'
		AND     WRITE_YMD   > '19900101'
		AND 	BANNER_REGI_YN = 'Y'    	 
    </select>
    
    <select id="searchCount" parameterType="map" resultType="int">
    	SELECT      
		       	count(*) CNT
		FROM    BBS     A 
		WHERE   BBS_TYPE    = 'C'
		AND     WRITE_YMD   > '19900101'
		AND   1    = 1
        <if test="searchTxt != null">        	
	        <choose>
		        <when test='searchCond == "A"'>
		        AND     TITLE     LIKE '%' + #{searchTxt} + '%'
		        </when>
		        <when test='searchCond == "B"'>
		        AND     CONTENTS  LIKE '%' + #{searchTxt} + '%'
		        </when>
		        <when test='searchCond == "C"'>
		        AND     (
		                      TITLE     LIKE '%' + #{searchTxt} + '%'
		                  OR  CONTENTS  LIKE '%' + #{searchTxt} + '%'
		                )
		        </when>
		        <when test='searchCond == "D"'>
		        AND     WRITE_YMD = #{searchTxt}
		        </when>
		        <when test='searchCond == "E"'>
		        AND     FN_USER_NAME(USER_ID) LIKE '%' +  #{searchTxt} + '%'
		        </when>
	        </choose>
       </if>
       <if test="searchGubun != null">
      		AND BBS_CATEGORY =	#{searchGubun}
       </if>      
       <if test='loginUserRole != "R999" and loginUserRole != "RDEV"'>
       		AND BBS_SHOW_YN	 = 'Y'
       </if> 
        <if test='dateUse != 0'>
        AND     WRITE_YMD          BETWEEN REPLACE(#{startDate},'-','') AND REPLACE(#{endDate},'-','')
        </if>
    </select>
    
    <select id="searchDetail" parameterType="map" resultType="ParamMap">
    	WITH WW AS
		(
			SELECT      
			       	A.ID
			,       A.TITLE
			,       A.USER_ID
			,       FN_USER_NAME(A.USER_ID) USER_NAME
			,       FN_TO_CHAR(CREATE_DATE, 'YYYY-MM-DD HH24:MI:SS') CREATE_DATE
			,       A.CONTENTS
			,		A.HIT
			,		FN_TO_CHAR(A.DATE_FROM, 'YYYY-MM-DD') DATE_FROM
			,		FN_TO_CHAR(A.DATE_TO, 'YYYY-MM-DD') DATE_TO
			,		A.BANNER_REGI_YN
			,		A.BANNER_IMG_YN
			,		A.BANNER_IMG_PATH
			,		A.BANNER_DEFAULT_IMG
			,       A.ATTACH_FILE_URL1
			,       A.ATTACH_FILE_URL2
			,       A.ATTACH_FILE_URL3
			,       A.ATTACH_FILE_URL4
			,       A.ATTACH_FILE_URL5
			,		A.BBS_CATEGORY
			,		A.BBS_SHOW_YN
			,       LAG(A.TITLE) OVER (ORDER BY ID) PRE_TITLE
			,       LEAD(A.TITLE) OVER (ORDER BY ID) AFT_TITLE
			,       ROW_NUMBER() OVER (ORDER BY ID) RID
			FROM    BBS     A 
			WHERE   BBS_TYPE    = 'C'
			AND     WRITE_YMD   > '19900101'
		)
		SELECT  *
		FROM    WW 
        WHERE 	1 =1 
		<if test = "rid != null">          
        AND   RID    = #{rid}
        </if>
        <if test = "rid == null and id != null">          
        AND   ID    = #{id}
        </if>
       
        
    </select>
    <select id="searchSub" parameterType="map" resultType="ParamMap">
       WITH WW AS
		(
		SELECT      
		       	A.ID
		,       A.TITLE
		,       A.USER_ID
		,       FN_USER_NAME(A.USER_ID) USER_NAME
		,       FN_TO_CHAR(CREATE_DATE, 'YYYY-MM-DD HH24:MI:SS') CREATE_DATE
		,       A.CONTENTS
		,		A.HIT
		,		A.WRITE_YMD
		,		BBS_SHOW_YN
		,       ROW_NUMBER() OVER (ORDER BY ID) RID
		FROM    BBS     A 
		WHERE   BBS_TYPE    = 'C'
		AND     WRITE_YMD   > '19900101'
		)
		SELECT  *
		FROM    WW 
        WHERE   RID BETWEEN #{rid} - 2 AND #{rid} + 2
        ORDER   BY
                RID DESC
    </select>
    <insert id="save" parameterType="map">
        MERGE INTO BBS A
        USING (SELECT 'A' AS A) B
        ON  A.ID = #{id}
        WHEN    MATCHED THEN
                UPDATE
                SET
                    TITLE               = #{title}
                ,   CONTENTS            = #{contents}
                ,   DATE_FROM           = #{dateFrom}
                ,   DATE_TO             = #{dateTo}
                ,   BANNER_REGI_YN      = #{bannerRegiYn}
                ,	BANNER_IMG_YN		= #{bannerImgYn}
                ,	BANNER_DEFAULT_IMG	= #{bannerDefaultImg}
                <if test = "bannerImgPath != null">                
                ,	BANNER_IMG_PATH		= #{bannerImgPath}
                </if> 
                <if test = "attachFileUrl1 != null">
                ,   ATTACH_FILE_URL1     = #{attachFileUrl1}
                </if>
                <if test = "attachFileUrl2 != null">
                ,   ATTACH_FILE_URL2     = #{attachFileUrl2}
                </if>
                <if test = "attachFileUrl3 != null">
                ,   ATTACH_FILE_URL3     = #{attachFileUrl3}
                </if>
                <if test = "attachFileUrl4 != null">
                ,   ATTACH_FILE_URL4     = #{attachFileUrl4}
                </if>
                <if test = "attachFileUrl5 != null">
                ,   ATTACH_FILE_URL5     = #{attachFileUrl5}
                </if>
                ,	BBS_SHOW_YN			= #{bbsShowYn}
                ,	BBS_CATEGORY		= #{bbsCategory}
                ,   UPDATE_BY           = #{loginUserId}
                ,   UPDATE_DATE     = NOW()
        WHEN    NOT MATCHED THEN
                INSERT
                (                 
                    TITLE               
                ,   CONTENTS            
                ,   WRITE_YMD           
                ,   USER_ID             
                ,   DATE_FROM           
                ,   DATE_TO             
                ,   BANNER_REGI_YN
                ,	BANNER_IMG_YN 
                ,	BANNER_DEFAULT_IMG
                <if test = "bannerImgPath != null">                
                ,	BANNER_IMG_PATH
                </if>  
                <if test = "attachFileUrl1 != null">   
                ,   ATTACH_FILE_URL1   
                </if>      
                <if test = "attachFileUrl2 != null">   
                ,   ATTACH_FILE_URL2   
                </if>
                <if test = "attachFileUrl3 != null">   
                ,   ATTACH_FILE_URL3   
                </if>
                <if test = "attachFileUrl4 != null">   
                ,   ATTACH_FILE_URL4   
                </if>
                <if test = "attachFileUrl5 != null">   
                ,   ATTACH_FILE_URL5   
                </if>                    
                ,   BBS_TYPE        
                ,	BBS_CATEGORY    
                ,   CREATE_BY           
                ,   CREATE_DATE       
                )
                VALUES
                (
                    #{title}
                ,   #{contents}
                ,   FN_TO_CHAR(NOW(), 'YYYYMMDD')
                ,   #{loginUserId}
                ,   #{dateFrom}
                ,   #{dateTo}
                ,   #{bannerRegiYn}
                ,	#{bannerImgYn}
                ,	#{bannerDefaultImg}
                <if test = "bannerImgPath != null">                
                ,	#{bannerImgPath}
                </if>
                <if test = "attachFileUrl1 != null">
                ,   #{attachFileUrl1}
                </if>
                <if test = "attachFileUrl2 != null">
                ,   #{attachFileUrl2}
                </if>
                <if test = "attachFileUrl3 != null">
                ,   #{attachFileUrl3}
                </if>
                <if test = "attachFileUrl4 != null">
                ,   #{attachFileUrl4}
                </if>
                <if test = "attachFileUrl5 != null">
                ,   #{attachFileUrl5}
                </if>
                ,   'C'
                ,	#{bbsCategory}
                ,   #{loginUserId}
                ,   NOW()
                );
    </insert>
    <update id="updateHit" parameterType="map">
    	WITH WW AS
		(
			SELECT      
			       	A.ID
			,       A.TITLE
			,       A.USER_ID
			,       FN_USER_NAME(A.USER_ID) USER_NAME
			,       FN_TO_CHAR(CREATE_DATE, 'YYYY-MM-DD HH24:MI:SS') CREATE_DATE
			,       A.CONTENTS
			,		A.HIT
			,       A.ATTACH_FILE_URL1
			,       A.ATTACH_FILE_URL2
			,       A.ATTACH_FILE_URL3
			,       A.ATTACH_FILE_URL4
			,       A.ATTACH_FILE_URL5
			,       LAG(A.TITLE) OVER (ORDER BY ID) PRE_TITLE
			,       LEAD(A.TITLE) OVER (ORDER BY ID) AFT_TITLE
			,       ROW_NUMBER() OVER (ORDER BY ID) RID
			FROM    BBS     A 
			WHERE   BBS_TYPE    = 'C'
			AND     WRITE_YMD   > '19900101'
		)
		UPDATE  WW
		   SET HIT = HIT +1
        WHERE   RID    = #{rid}
    </update>
    
    <delete id="delete" parameterType="map">
        DELETE  FROM BBS
        WHERE   ID = #{id}
    </delete>
    
    <update id="fileDelete" parameterType="map">
    	UPDATE  BBS
    	SET     
    			<if test ="fileUrlDelete1 != null">ATTACH_FILE_URL1 = NULL,</if>
    			<if test ="fileUrlDelete2 != null">ATTACH_FILE_URL2 = NULL,</if>
    			<if test ="fileUrlDelete3 != null">ATTACH_FILE_URL3 = NULL,</if>
    			<if test ="fileUrlDelete4 != null">ATTACH_FILE_URL4 = NULL,</if>
    			<if test ="fileUrlDelete5 != null">ATTACH_FILE_URL5 = NULL,</if>
    			UPDATE_DATE     = NOW()
        WHERE   ID = #{id}
    </update>
</mapper>